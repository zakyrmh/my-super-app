// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =======================
// USER & AUTH
// =======================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())

  // Relations
  accounts              Account[]
  vehicles              Vehicle[]
  debts                 Debt[]
  contacts              Contact[]
  categories            Category[]
  transactions          Transaction[]
  foodLogs              FoodLog[]
  fundingSources        FundingSource[]
  budgets               Budget[]
  recurringTransactions RecurringTransaction[]
  financialGoals        FinancialGoal[]
  netWorthSnapshots     NetWorthSnapshot[]
  medicalHistories      MedicalHistory[]
  exerciseLogs          ExerciseLog[]
}

// =======================
// 1. MODULE KEUANGAN
// =======================

// Enum for Account Type
enum AccountType {
  BANK
  EWALLET
  CASH
  INVESTMENT
  CREDIT
}

model Account {
  id   String      @id @default(uuid())
  name String // Misal: "Shopee Paylater", "BCA Card"
  type AccountType // Menggunakan Enum!

  // Saldo saat ini.
  // Untuk CREDIT: -500.000 berarti anda punya hutang 500rb. 
  // 0 berarti lunas.
  balance Decimal @default(0)

  // Field khusus Kartu Kredit / Paylater
  creditLimit   Decimal? // Batas limit, misal 10.000.000
  statementDate Int? // Tanggal cetak tagihan (misal tgl 20)
  dueDate       Int? // Tanggal jatuh tempo (misal tgl 5)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relasi Transaksi
  outgoingTx Transaction[] @relation("SenderAccount")
  incomingTx Transaction[] @relation("ReceiverAccount")
}

model Transaction {
  id          String          @id @default(uuid())
  date        DateTime        @default(now())
  type        TransactionType
  amount      Decimal
  description String?

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  receiptUrl String?

  isPersonal Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fromAccountId String?
  fromAccount   Account? @relation("SenderAccount", fields: [fromAccountId], references: [id])

  toAccountId String?
  toAccount   Account? @relation("ReceiverAccount", fields: [toAccountId], references: [id])

  items    TransactionItem[]
  fundings TransactionFunding[]

  reconciliationStatus ReconciliationStatus @default(PENDING)

  createdAt DateTime @default(now())
}

model TransactionFunding {
  id     String  @id @default(uuid())
  amount Decimal

  fundingSourceId String
  fundingSource   FundingSource @relation(fields: [fundingSourceId], references: [id])

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model FundingSource {
  id   String            @id @default(uuid())
  name String // "Gaji Januari", "THR 2025", "Bonus Proyek A"
  type FundingSourceType
  note String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fundings TransactionFunding[]
  budgets  Budget[]

  createdAt      DateTime        @default(now())
  financialGoals FinancialGoal[]

  @@unique([userId, name])
}

enum FundingSourceType {
  INCOME
  SAVING
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  LENDING
  REPAYMENT
}

enum ReconciliationStatus {
  PENDING
  MATCHED
  ADJUSTED
}

model TransactionItem {
  id    String  @id @default(uuid())
  name  String // Indomie, Sabun
  price Decimal
  qty   Int     @default(1)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

// Manajemen Hutang Piutang
model Contact {
  id     String @id @default(uuid())
  name   String // Nama teman/keluarga
  userId String
  user   User   @relation(fields: [userId], references: [id])
  debts  Debt[]
}

model Debt {
  id          String    @id @default(uuid())
  type        DebtType // LENDING (Saya meminjamkan), BORROWING (Saya berhutang)
  amount      Decimal
  remaining   Decimal // Sisa hutang
  description String?
  dueDate     DateTime?
  isPaid      Boolean   @default(false)

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  createdAt DateTime @default(now())
}

enum DebtType {
  LENDING
  BORROWING
}

model Budget {
  id     String  @id @default(uuid())
  month  Int // 1â€“12
  year   Int
  amount Decimal

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  fundingSourceId String?
  fundingSource   FundingSource? @relation(fields: [fundingSourceId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, month, year, categoryId, fundingSourceId])
}

model RecurringTransaction {
  id     String          @id @default(uuid())
  type   TransactionType
  amount Decimal
  note   String?

  interval RecurringInterval
  startAt  DateTime
  endAt    DateTime?

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  fromAccountId String?
  toAccountId   String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum RecurringInterval {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model FinancialGoal {
  id       String    @id @default(uuid())
  name     String
  target   Decimal
  current  Decimal   @default(0)
  deadline DateTime?
  note     String?

  fundingSourceId String?
  fundingSource   FundingSource? @relation(fields: [fundingSourceId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model NetWorthSnapshot {
  id          String  @id @default(uuid())
  total       Decimal
  assets      Decimal
  liabilities Decimal

  date DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =======================
// 2. MODULE KESEHATAN (AI)
// =======================

model FoodLog {
  id          String  @id @default(uuid())
  imageUrl    String
  description String?

  // 1. Macro Nutrients (Wajib ada kolom sendiri untuk grafik/chart)
  calories     Int? // kkal
  protein      Float? // gram
  carbs        Float? // gram
  fat          Float? // gram
  saturatedFat Float? // gram (Lemak Jenuh)
  transFat     Float? // gram (Lemak Trans)
  polyFat      Float? // gram (Lemak Tak Jenuh Ganda)
  monoFat      Float? // gram (Lemak Tak Jenuh Tunggal)

  // 2. Key Micro Nutrients (Penting untuk kesehatan umum)
  fiber       Float? // Serat (gram) -> Penting untuk pencernaan
  sugar       Float? // Gula (gram) -> Penting untuk diabetes/energi
  sodium      Float? // Natrium (mg) -> Penting untuk tekanan darah
  cholesterol Float? // Kolesterol (mg) -> Penting untuk jantung
  potassium   Float? // Kalium (mg) -> Penting untuk fungsi otot/syaraf
  calcium     Float? // Kalsium (mg) -> Kesehatan tulang
  iron        Float? // Zat Besi (mg) -> Kesehatan darah
  vitaminA    Float? // Vitamin A (IU)
  vitaminC    Float? // Vitamin C (mg)
  vitaminD    Float? // Vitamin D (IU)

  // 3. Detailed Micronutrients (Flexible JSON)
  // AI akan menyimpan data seperti: {"vitamin_b12": "2.4mcg", "magnesium": "400mg"}
  micronutrients Json?

  // Analisis Teknis AI
  aiAnalysis String? @db.Text // Penjelasan tekstual: "Makanan ini tinggi natrium, kurangi porsi makan malam."

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model MedicalHistory {
  id        String @id @default(uuid())
  condition String // Nama penyakit/kondisi (e.g., "Hypertension", "Diabetes Type 2")

  diagnosedDate DateTime? // Tanggal diagnosa
  status        MedicalStatus   @default(ACTIVE)
  severity      MedicalSeverity // MILD, MODERATE, SEVERE

  notes     String? @db.Text // Catatan dokter, gejala, pantangan
  treatment String? // Obat-obatan atau terapi yang dijalani

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum MedicalStatus {
  ACTIVE // Sedang diderita
  CURED // Sudah sembuh
  MANAGED // Terkontrol (kronis tapi stabil)
  REMISSION // Masa remisi
}

enum MedicalSeverity {
  MILD
  MODERATE
  SEVERE
  CRITICAL
}

model ExerciseLog {
  id           String       @id @default(uuid())
  activityName String // Jenis olahraga: "Lari Pagi", "Gym Session-Leg Day"
  type         ExerciseType

  duration       Int // Durasi dalam menit
  caloriesBurned Int? // Estimasi kalori terbakar

  // Data spesifik
  distance     Float? // Jarak dalam KM (untuk lari/sepeda/renang)
  steps        Int? // Jumlah langkah
  avgHeartRate Int? // Detak jantung rata-rata (bpm)

  intensity ExerciseIntensity
  notes     String? // "Lari santai di taman", "Repetisi beban maksimal naik"

  date DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum ExerciseType {
  CARDIO // Lari, Renang, Sepeda
  STRENGTH // Angkat beban, Gym
  FLEXIBILITY // Yoga, Stretching
  SPORTS // Basket, Sepak bola, Bulutangkis
  OTHER
}

enum ExerciseIntensity {
  LOW
  MODERATE
  HIGH
  EXTREME
}

// =======================
// 3. MODULE KENDARAAN
// =======================

model Vehicle {
  id          String  @id @default(uuid())
  name        String // Vario 150, Avanza
  plateNumber String?
  initialOdo  Int // KM awal saat masuk app
  currentOdo  Int // KM terakhir (Update otomatis dari log bensin/servis)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  serviceLogs ServiceLog[]
  fuelLogs    FuelLog[]
}

model ServiceLog {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  odometer    Int // KM saat servis
  description String // Ganti Oli, Ganti Vanbelt
  cost        Decimal
  notes       String? // "Bengkel resmi Honda"

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model FuelLog {
  id         String   @id @default(uuid())
  date       DateTime @default(now())
  odometer   Int // KM saat isi bensin
  liters     Float
  cost       Decimal
  isFullTank Boolean  @default(true) // Penting untuk kalkulasi akurat

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

// =======================
// 4. MODULE KATEGORI (AI)
// =======================

model Category {
  id       String          @id @default(uuid())
  name     String
  type     TransactionType // INCOME or EXPENSE
  keywords String[] // Keywords for AI matching e.g. ["makan", "restoran", "warteg"]

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Inverse Relation to Transaction
  transactions     Transaction[]
  transactionItems TransactionItem[]

  createdAt             DateTime               @default(now())
  budgets               Budget[]
  recurringTransactions RecurringTransaction[]

  @@unique([userId, name, type])
}
