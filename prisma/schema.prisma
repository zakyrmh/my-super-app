// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =======================
// USER & AUTH
// =======================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())

  // Relations
  accounts Account[]
  vehicles Vehicle[]
  debts    Debt[]
  contacts Contact[] // Daftar teman/orang untuk hutang piutang
}

// =======================
// 1. MODULE KEUANGAN
// =======================

model Account {
  id   String @id @default(uuid())
  name String // Misal: "Shopee Paylater", "BCA Card"
  type String // BANK, EWALLET, CASH, INVESTMENT, CREDIT (Baru!)

  // Saldo saat ini.
  // Untuk CREDIT: -500.000 berarti anda punya hutang 500rb. 
  // 0 berarti lunas.
  balance Decimal @default(0)

  // Field khusus Kartu Kredit / Paylater
  creditLimit   Decimal? // Batas limit, misal 10.000.000
  statementDate Int? // Tanggal cetak tagihan (misal tgl 20)
  dueDate       Int? // Tanggal jatuh tempo (misal tgl 5)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relasi Transaksi
  outgoingTx Transaction[] @relation("SenderAccount")
  incomingTx Transaction[] @relation("ReceiverAccount")
}

model Transaction {
  id          String          @id @default(uuid())
  date        DateTime        @default(now())
  type        TransactionType // INCOME, EXPENSE, TRANSFER
  amount      Decimal
  description String?

  // Kategori & AI
  category   String? // Makanan, Transport (Auto-generated by AI)
  receiptUrl String? // Foto struk di Supabase Storage

  // Logic "Titipan" / Flow
  isPersonal Boolean @default(true) // False jika bayarin BPJS ortu atau uang lewat
  flowTag    String? // Label opsional: "Gaji", "Dividen" (untuk tracking sumber dana)

  // Relasi Akun (Transfer logic: From -> To)
  fromAccountId String?
  fromAccount   Account? @relation("SenderAccount", fields: [fromAccountId], references: [id])
  toAccountId   String?
  toAccount     Account? @relation("ReceiverAccount", fields: [toAccountId], references: [id])

  // Relasi Item (Belanja Supermarket)
  items    TransactionItem[]
  fundings TransactionFunding[]

  createdAt DateTime @default(now())
}

model TransactionFunding {
  id        String  @id @default(uuid())
  amount    Decimal // Nominal yang diambil (misal: 500.000)
  sourceTag String // Nama Tag (misal: "Gaji")

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model TransactionItem {
  id       String  @id @default(uuid())
  name     String // Indomie, Sabun
  price    Decimal
  qty      Int     @default(1)
  category String? // Kategori per item (Auto AI)

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

// Manajemen Hutang Piutang
model Contact {
  id     String @id @default(uuid())
  name   String // Nama teman/keluarga
  userId String
  user   User   @relation(fields: [userId], references: [id])
  debts  Debt[]
}

model Debt {
  id          String    @id @default(uuid())
  type        DebtType // LENDING (Saya meminjamkan), BORROWING (Saya berhutang)
  amount      Decimal
  remaining   Decimal // Sisa hutang
  description String?
  dueDate     DateTime?
  isPaid      Boolean   @default(false)

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  createdAt DateTime @default(now())
}

enum DebtType {
  LENDING
  BORROWING
}

// =======================
// 2. MODULE KESEHATAN (AI)
// =======================

model FoodLog {
  id          String  @id @default(uuid())
  imageUrl    String
  description String?

  // 1. Macro Nutrients (Wajib ada kolom sendiri untuk grafik/chart)
  calories Int? // kkal
  protein  Float? // gram
  carbs    Float? // gram
  fat      Float? // gram

  // 2. Key Micro Nutrients (Penting untuk kesehatan umum)
  fiber       Float? // Serat (gram) -> Penting untuk pencernaan
  sugar       Float? // Gula (gram) -> Penting untuk diabetes/energi
  sodium      Float? // Natrium (mg) -> Penting untuk tekanan darah
  cholesterol Float? // Kolesterol (mg) -> Penting untuk jantung

  // 3. Detailed Micronutrients (Flexible JSON)
  // AI akan menyimpan data seperti: {"vitamin_c": "10mg", "calcium": "5%", "iron": "2mg"}
  micronutrients Json?

  // Analisis Teknis AI
  aiAnalysis String? @db.Text // Penjelasan tekstual: "Makanan ini tinggi natrium, kurangi porsi makan malam."

  userId    String
  // user     User     @relation...
  createdAt DateTime @default(now())
}

// =======================
// 3. MODULE KENDARAAN
// =======================

model Vehicle {
  id          String  @id @default(uuid())
  name        String // Vario 150, Avanza
  plateNumber String?
  initialOdo  Int // KM awal saat masuk app
  currentOdo  Int // KM terakhir (Update otomatis dari log bensin/servis)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  serviceLogs ServiceLog[]
  fuelLogs    FuelLog[]
}

model ServiceLog {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  odometer    Int // KM saat servis
  description String // Ganti Oli, Ganti Vanbelt
  cost        Decimal
  notes       String? // "Bengkel resmi Honda"

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model FuelLog {
  id         String   @id @default(uuid())
  date       DateTime @default(now())
  odometer   Int // KM saat isi bensin
  liters     Float
  cost       Decimal
  isFullTank Boolean  @default(true) // Penting untuk kalkulasi akurat

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}
